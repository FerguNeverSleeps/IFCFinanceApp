<!doctype html>
<html lang="en">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Offering Entry</title>
  <style>
    fieldset { border: 1px solid #ccc; padding: 1em; }
    .denom-row { display: flex; align-items: center; margin-bottom: 0.5em; }
    .denom-row label { width: 6em; }
    .denom-row input[type="number"] { width: 4em; margin-right: 1em; }
    .denom-row .line-value { width: 6em; text-align: right; border: none; background: none; font-weight: bold; }
    #grand-total { margin-top: 1em; font-size: 1.5em; font-weight: bold; }
  </style>
</head>
<body>
  <h2>Record Offering</h2>
  <!-- Flash messages -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      <ul>
      {% for cat,msg in messages %}
        <li class="{{cat}}">{{msg}}</li>
      {% endfor %}
      </ul>
    {% endif %}
  {% endwith %}

  <!-- Everything inside #offering-print is what goes into the PDF -->
  <div id="offering-print">
    <form id="offering-form" method="post">
      <label>Date:
        <input type="date" name="date" id="off_date" required
               value="{{ F.get('date') if F else '' }}">
      </label>
      <br><br>

      <fieldset>
        <legend>Denomination Counts:</legend>

        {% set z = '0' %}
        <div class="denom-row" data-denom="100.00">
          <label>100.00 &euro;:</label>
          <input type="number" min="0" name="count_100_00" value="{{ (F.get('count_100_00') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="50.00">
          <label>50.00 &euro;:</label>
          <input type="number" min="0" name="count_50_00" value="{{ (F.get('count_50_00') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="20.00">
          <label>20.00 &euro;:</label>
          <input type="number" min="0" name="count_20_00" value="{{ (F.get('count_20_00') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="10.00">
          <label>10.00 &euro;:</label>
          <input type="number" min="0" name="count_10_00" value="{{ (F.get('count_10_00') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="5.00">
          <label>5.00 &euro;:</label>
          <input type="number" min="0" name="count_5_00" value="{{ (F.get('count_5_00') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="2.00">
          <label>2.00 &euro;:</label>
          <input type="number" min="0" name="count_2_00" value="{{ (F.get('count_2_00') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="1.00">
          <label>1.00 &euro;:</label>
          <input type="number" min="0" name="count_1_00" value="{{ (F.get('count_1_00') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="0.50">
          <label>0.50 &euro;:</label>
          <input type="number" min="0" name="count_0_50" value="{{ (F.get('count_0_50') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="0.20">
          <label>0.20 &euro;:</label>
          <input type="number" min="0" name="count_0_20" value="{{ (F.get('count_0_20') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="0.10">
          <label>0.10 &euro;:</label>
          <input type="number" min="0" name="count_0_10" value="{{ (F.get('count_0_10') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="0.05">
          <label>0.05 &euro;:</label>
          <input type="number" min="0" name="count_0_05" value="{{ (F.get('count_0_05') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
        <div class="denom-row" data-denom="0.01">
          <label>0.01 &euro;:</label>
          <input type="number" min="0" name="count_0_01" value="{{ (F.get('count_0_01') if F else z) or z }}" class="count-input">
          <input type="text" readonly class="line-value" value="€0.00">
        </div>
      </fieldset>

      <div id="grand-total">Grand Total: &euro;0.00</div>
      <input type="hidden" name="total_cash" id="total_cash_input" value="{{ F.get('total_cash') if F else '0' }}">

      <fieldset style="margin-top:1em; border:1px solid #ccc; padding:1em;">
        <legend>Personnel</legend>
        <div>
          <label style="display:inline-block;width:8em;">Counted By:</label>
          <input type="text" id="counted_by" name="counted_by" required
                 value="{{ F.get('counted_by') if F else '' }}">
        </div>
        <div>
          <label style="display:inline-block;width:8em;">Checked By:</label>
          <input type="text" id="checked_by" name="checked_by" required
                 value="{{ F.get('checked_by') if F else '' }}">
        </div>
        <div>
          <label style="display:inline-block;width:8em;">Carrier of Envelope:</label>
          <input type="text" id="carrier" name="carrier_of_envelope" required
                 value="{{ F.get('carrier_of_envelope') if F else '' }}">
        </div>
      </fieldset>

      <button type="submit" id="saveBtn">Save</button>
    </form>
  </div>
  <p><a href="/">← Back</a> | <a href="report.html">Report</a></p>
  <script>
  // --- totals calc ---
  function recalc() {
    let grand = 0;
    document.querySelectorAll('.denom-row').forEach(row => {
      const denom = parseFloat(row.dataset.denom);
      const input = row.querySelector('.count-input');
      const count = parseInt(input.value || '0', 10) || 0;
      const line  = denom * count;
      row.querySelector('.line-value').value = new Intl.NumberFormat('en-IE',
        { style:'currency', currency:'EUR' }).format(line);
      grand += line;
    });
    document.getElementById('grand-total').textContent =
      'Grand Total: ' + new Intl.NumberFormat('en-IE', { style:'currency', currency:'EUR' }).format(grand);
    document.getElementById('total_cash_input').value = grand.toFixed(2);
  }
  document.addEventListener('input', e => {
    if (e.target.classList.contains('count-input')) recalc();
  });
  // recalc once to sync values from F (if any)
  window.addEventListener('DOMContentLoaded', recalc);

  // --- validation + pdf + submit ---
  document.getElementById('offering-form').addEventListener('submit', async (ev) => {
    const dateEl = document.getElementById('off_date');
    const counted = document.getElementById('counted_by').value.trim();
    const checked = document.getElementById('checked_by').value.trim();
    const carrier = document.getElementById('carrier').value.trim();

    // at least one denomination?
    let anyCount = false;
    document.querySelectorAll('.count-input').forEach(el => {
      const v = parseInt(el.value || '0', 10);
      if (v > 0) anyCount = true;
    });

    if (!dateEl.value || !anyCount || !(counted && checked && carrier)) {
      // Let Flask re-render with F=form so inputs stay filled
      return; // do nothing; regular POST will return 400 + sticky form
    }

    // If valid: generate the PDF first, then submit normally
    ev.preventDefault();
    const filename = (() => {
      const d = (dateEl.value || new Date().toISOString().slice(0,10)).replace(/-/g,'');
      const rnd = Math.random().toString(36).slice(2,7).toUpperCase();
      return `OFF-${d}-${rnd}.pdf`;
    })();

    await html2pdf()
      .set({
        margin: [10,10,10,10],
        filename,
        image: { type:'jpeg', quality:0.98 },
        html2canvas: { scale:2, useCORS:true },
        jsPDF: { unit:'mm', format:'a4', orientation:'portrait' }
      })
      .from(document.getElementById('offering-print'))
      .save();

    ev.target.submit(); // now let Flask handle the POST (success clears on redirect)
  });
  </script>

<script>
  document.querySelector('form').addEventListener('submit', function (ev) {
    // require at least one denomination > 0
    let anyPositive = false;
    for (const el of this.elements) {
      if (el.name && el.name.startsWith('count_')) {
        const v = parseInt(el.value || '0', 10);
        if (v > 0) { anyPositive = true; break; }
      }
    }
    const missingPersonnel =
      !document.getElementById('counted_by').value.trim() ||
      !document.getElementById('checked_by').value.trim() ||
      !document.getElementById('carrier').value.trim();

    if (!anyPositive) {
      ev.preventDefault();
      alert('Please enter at least one denomination count greater than 0.');
      return;
    }
    if (missingPersonnel) {
      ev.preventDefault();
      alert('Please fill Counted By, Checked By, and Carrier of Envelope.');
      return;
    }
  });
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const form      = document.getElementById('offering-form');   // <form id="offering-form" ...>
  const printArea = document.getElementById('offering-print');

  const dateEl    = document.getElementById('off_date');        // <input name="date" id="off_date">
  const countedEl = document.getElementById('counted_by');
  const checkedEl = document.getElementById('checked_by');
  const carrierEl = document.getElementById('carrier');

  function anyDenomination() {
    let sum = 0;
    document.querySelectorAll('input[name^="count_"]').forEach(el => {
      const n = parseInt(el.value || '0', 10);
      if (!isNaN(n)) sum += n;
    });
    return sum > 0;
  }

  function personnelOk() {
    return [countedEl, checkedEl, carrierEl].every(el => (el?.value || '').trim().length > 0);
  }

  function validate(showMsg=true) {
    const hasDate = !!(dateEl && dateEl.value);
    const hasCounts = anyDenomination();
    const hasPeople = personnelOk();

    if (showMsg) {
      if (!hasDate)   { alert('Please select a date.'); return false; }
      if (!hasCounts) { alert('Enter at least one denomination count > 0.'); return false; }
      if (!hasPeople) { alert('Fill Counted By, Checked By, and Carrier of Envelope.'); return false; }
    }
    return hasDate && hasCounts && hasPeople;
  }

  function filename() {
    const d = (dateEl?.value || new Date().toISOString().slice(0,10)).replace(/-/g,'');
    const rnd = Math.random().toString(36).slice(2,7).toUpperCase();
    return `OFF-${d}-${rnd}.pdf`;
  }

  const pdfOpts = fn => ({
    margin: [10,10,10,10],
    filename: fn,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  });

  // Intercept the single Save submit
  form?.addEventListener('submit', async (e) => {
    if (!validate(true)) { e.preventDefault(); return; }
    e.preventDefault();                        // wait for PDF to finish
    await html2pdf().set(pdfOpts(filename())).from(printArea).save();
    form.submit();                             // then continue normal submit (no duplicate handlers)
  });
});
</script>
</body>
</html>