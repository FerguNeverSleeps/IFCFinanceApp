{% extends "base.html" %}

{% block title %}Record Offering - ICF Finance{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px;">

  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2>Record Sunday Offering</h2>
    <a href="{{ url_for('index') }}" class="btn btn-outline">‚Üê Back to Dashboard</a>
  </div>

  <!-- Flash messages are handled in base.html now -->

  <div class="card">
    <form id="offering-form" method="post" action="{{ url_for('cash_split_entry') }}">

      <div style="margin-bottom: 2rem;">
        <label style="font-weight: 600;">Date:</label>
        <input type="date" name="date" id="off_date" required
          style="padding: 0.5rem; border-radius: 0.3rem; border: 1px solid #ccc; margin-left: 1rem;"
          value="{{ F.get('date') if F else '' }}">
      </div>

      <fieldset
        style="border: 1px solid var(--color-border); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
        <legend style="padding: 0 0.5rem; font-weight: 600; color: var(--color-primary);">Denomination Counts</legend>

        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
          {% set denoms = ['100.00', '50.00', '20.00', '10.00', '5.00', '2.00', '1.00', '0.50', '0.20', '0.10', '0.05',
          '0.01'] %}
          {% for d in denoms %}
          <div class="denom-row" data-denom="{{ d }}"
            style="display: flex; align-items: center; justify-content: space-between; background: #f9fafb; padding: 0.5rem; border-radius: 0.5rem;">
            <label style="width: 4rem;">‚Ç¨{{ d }}:</label>
            <input type="number" min="0" name="count_{{ d.replace('.','_') }}"
              value="{{ (F.get('count_' + d.replace('.','_')) if F else '0') or '0' }}" class="count-input"
              style="width: 4rem; padding: 0.25rem; text-align: center;">
            <input type="text" readonly class="line-value" value="‚Ç¨0.00"
              style="width: 5rem; text-align: right; border: none; background: transparent; font-weight: 600; color: var(--color-primary);">
          </div>
          {% endfor %}
        </div>
      </fieldset>

      <div id="grand-total"
        style="text-align: right; font-size: 1.5rem; font-weight: 700; color: var(--color-primary-dark); margin-bottom: 2rem;">
        Grand Total: ‚Ç¨0.00
      </div>
      <input type="hidden" name="total_cash_input" id="total_cash_input"
        value="{{ F.get('total_cash') if F else '0' }}">

      <fieldset
        style="border: 1px solid var(--color-border); padding: 1.5rem; border-radius: 0.75rem; margin-bottom: 2rem;">
        <legend style="padding: 0 0.5rem; font-weight: 600; color: var(--color-primary);">Personnel</legend>
        <div style="display: grid; gap: 1rem;">
          <div style="display: flex; gap: 1rem; align-items: center;">
            <label style="width: 150px;">Counted By:</label>
            <input type="text" name="counted_by" required
              style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.3rem;"
              value="{{ F.get('counted_by') if F else '' }}">
          </div>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <label style="width: 150px;">Checked By:</label>
            <input type="text" name="checked_by" required
              style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.3rem;"
              value="{{ F.get('checked_by') if F else '' }}">
          </div>
          <div style="display: flex; gap: 1rem; align-items: center;">
            <label style="width: 150px;">Envelope Carrier:</label>
            <input type="text" name="carrier_of_envelope" required
              style="flex: 1; padding: 0.5rem; border: 1px solid #ccc; border-radius: 0.3rem;"
              value="{{ F.get('carrier_of_envelope') if F else '' }}">
          </div>
        </div>
      </fieldset>

      <div style="display: flex; gap: 1rem; justify-content: flex-end;">
        <button type="button" id="savePdfBtn" class="btn btn-outline">üìÑ Save as PDF</button>
        <button type="submit" id="saveBtn" class="btn btn-primary">üíæ Save Record</button>
      </div>
    </form>
  </div>
</div>

<!-- Print Area Hidden Logic: We reuse the script but maybe hide this div or style it for print -->
<div id="offering-print" style="display:none;">
  <!-- Minimal clone for PDF generation if needed, or we adapt the script to capture the main form -->
  <!-- For simplicity, let's keep the script logic looking at 'offering-form' or adapt the print area to be the card itself -->
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  function formatEUR(cents) {
    return new Intl.NumberFormat('en-IE', { style: 'currency', currency: 'EUR' }).format(cents / 100);
  }

  function recalc() {
    let grandCents = 0;
    document.querySelectorAll('.denom-row').forEach(row => {
      const denomStr = row.dataset.denom;
      const denomCents = Math.round(Number(denomStr) * 100);
      const input = row.querySelector('.count-input');
      const count = parseInt(input.value || '0', 10) || 0;
      const lineCents = denomCents * count;
      row.querySelector('.line-value').value = formatEUR(lineCents);
      grandCents += lineCents;
    });
    document.getElementById('grand-total').textContent = 'Grand Total: ' + formatEUR(grandCents);
    document.getElementById('total_cash_input').value = (grandCents / 100).toFixed(2);
  }

  document.addEventListener('input', e => {
    if (e.target.classList.contains('count-input')) recalc();
  });
  window.addEventListener('DOMContentLoaded', recalc);

  // PDF Logic
  document.getElementById('savePdfBtn').addEventListener('click', async () => {
    recalc();
    const element = document.querySelector('.card'); // Capture the whole card
    const d = (document.getElementById('off_date')?.value || new Date().toISOString().slice(0, 10)).replace(/-/g, '');
    const filename = `OFF-${d}.pdf`;

    await html2pdf().set({
      margin: 10,
      filename: filename,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
    }).from(element).save();

    // Submit form after minimal delay
    setTimeout(() => document.getElementById('offering-form').submit(), 1000);
  });
</script>
{% endblock %}