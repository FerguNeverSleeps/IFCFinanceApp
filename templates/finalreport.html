{% extends "base.html" %}

{% block title %}Final Category Report - ICF Finance{% endblock %}

{% block content %}
<div class="container container-lg">

  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2>Final Category Report</h2>
    <a href="{{ url_for('index') }}" class="btn btn-outline">← Back to Dashboard</a>
  </div>

  <!-- Controls -->
  <div class="card" style="margin-bottom: 2rem;">
    <form method="get" style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: flex-end;">
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">Start Date</label>
        <input type="date" name="startdate" id="startdate" value="{{ start }}"
          style="padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 0.3rem;">
      </div>
      <div>
        <label style="display: block; margin-bottom: 0.5rem; font-weight: 500;">End Date</label>
        <input type="date" name="enddate" id="enddate" value="{{ end }}"
          style="padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 0.3rem;">
      </div>
      <button type="submit" class="btn btn-primary">Filter Report</button>
      <button type="button" id="downloadPdf" class="btn btn-outline">Download PDF</button>
    </form>
  </div>

  <!-- PDF Area -->
  <div id="pdf-area"
    style="background: white; padding: 2rem; border-radius: 0.5rem; border: 1px solid var(--color-border);">
    <h1 style="margin-bottom: 0.5rem;">{{ title }}</h1>
    <p style="margin-bottom: 2rem; color: var(--color-text-muted);">
      Period: <strong>{{ start or 'All Time' }}</strong> to <strong>{{ end or 'All Time' }}</strong>
    </p>

    <table class="table" style="width: 100%;">
      <thead>
        <tr>
          <th style="border-bottom: 2px solid #e5e7eb;">Category</th>
          <th style="text-align: right; border-bottom: 2px solid #e5e7eb;">Assets</th>
          <th style="text-align: right; border-bottom: 2px solid #e5e7eb;">Liabilities</th>
          <th style="text-align: right; border-bottom: 2px solid #e5e7eb;">Difference</th>
        </tr>
      </thead>
      <tbody>
        {% macro euro(v) -%}€ {{ '{:,.2f}'.format(v) }}{%- endmacro %}
        {% for row in rows %}
        <tr>
          <td style="font-weight: 500;">{{ row.category }}</td>
          <td style="text-align: right;">{{ euro(row.assets) }}</td>
          <td style="text-align: right;">{{ euro(row.liabilities) }}</td>
          <td
            style="text-align: right; font-weight: 600; {{ 'color: #dc2626;' if row.difference < 0 else 'color: #166534;' }}">
            {{ euro(row.difference) }}
          </td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr style="background-color: #f9fafb; font-weight: 700;">
          <td style="border-top: 2px solid #e5e7eb;">Totals</td>
          <td style="text-align: right; border-top: 2px solid #e5e7eb;">{{ euro(totals.assets) }}</td>
          <td style="text-align: right; border-top: 2px solid #e5e7eb;">{{ euro(totals.liabilities) }}</td>
          <td
            style="text-align: right; border-top: 2px solid #e5e7eb; {{ 'color: #dc2626;' if totals.difference < 0 else 'color: #166534;' }}">
            {{ euro(totals.difference) }}
          </td>
        </tr>
      </tfoot>
    </table>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
  document.getElementById('downloadPdf').addEventListener('click', function () {
    const el = document.getElementById('pdf-area');
    const start = document.getElementById('startdate')?.value || "{{ start or '' }}";
    const end = document.getElementById('enddate')?.value || "{{ end or '' }}";
    const fname = `category_report_${start || 'all'}_${end || 'all'}.pdf`;

    html2pdf().set({
      margin: 10,
      filename: fname,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, backgroundColor: '#ffffff' },
      jsPDF: { unit: 'pt', format: 'a4', orientation: 'portrait' }
    }).from(el).save();
  });
</script>
{% endblock %}