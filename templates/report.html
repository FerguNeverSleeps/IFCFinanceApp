{% extends "base.html" %}

{% block title %}Income Report - ICF Finance{% endblock %}

{% block content %}
<div class="container margin-top-lg">
  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
    <h2>Income Report</h2>
    <a href="{{ url_for('index') }}" class="btn btn-outline">← Back to Dashboard</a>
  </div>

  <!-- Filters Card -->
  <div class="card" style="margin-bottom: 2rem;">
    <form method="get" action="{{ url_for('reportfinance_view') }}"
      style="display: flex; flex-wrap: wrap; gap: 1.5rem; align-items: flex-end;">

      <div>
        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Start Date</label>
        <input type="date" name="start_date" id="start_date" value="{{ start_date or '' }}" required
          style="padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 0.3rem;">
      </div>

      <div>
        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">End Date</label>
        <input type="date" name="end_date" id="end_date" value="{{ end_date or '' }}" required
          style="padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 0.3rem;">
      </div>

      <div style="flex: 1; min-width: 200px;">
        <label style="display: block; font-weight: 500; margin-bottom: 0.5rem;">Category</label>
        <select name="category"
          style="width: 100%; padding: 0.5rem; border: 1px solid var(--color-border); border-radius: 0.3rem;">
          {% set sel = (selected_category or '')|lower %}
          <option value="all categories" {% if sel in ('', 'all' , 'all categories' ) %}selected{% endif %}>All
            Categories</option>
          <option value="offering" {% if sel=='offering' %}selected{% endif %}>Offering</option>
          <option value="rent" {% if sel=='rent' %}selected{% endif %}>Rent</option>
          <option value="charity" {% if sel=='charity' %}selected{% endif %}>Charity</option>
          <option value="givt" {% if sel=='givt' %}selected{% endif %}>GIVT</option>
          <option value="food/beverages" {% if sel=='food/beverages' %}selected{% endif %}>Food/Beverages</option>
          <option value="tithe/rabo" {% if sel=='tithe/rabo' %}selected{% endif %}>Tithe/Rabo</option>
          <option value="preacher" {% if sel=='preacher' %}selected{% endif %}>Preacher</option>
          <option value="events" {% if sel=='events' %}selected{% endif %}>Events</option>
          <option value="others" {% if sel=='others' %}selected{% endif %}>Others</option>
        </select>
      </div>

      <div style="display: flex; gap: 0.5rem;">
        <button type="submit" class="btn btn-primary">Filter</button>
        <a href="{{ url_for('reportfinance_view') }}" class="btn btn-outline">Clear</a>
      </div>

      <button type="submit" formaction="/reportsummary.html" formmethod="get" class="btn btn-outline"
        style="margin-left: auto;">
        View Summary
      </button>
    </form>
  </div>

  <!-- Results Table -->
  <div class="table-container">
    <table class="table">
      <thead>
        <tr>
          <th>Date</th>
          <th>Subject</th>
          <th>Type</th>
          <th>Category</th>
          <th>Amount (€)</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        {% for r in rows %}
        <tr>
          <td>{{ r.date.strftime('%Y-%m-%d') if r.date else '' }}</td>
          <td>{{ r.subject }}</td>
          <td><span style="text-transform: capitalize;">{{ r.type_ofspending }}</span></td>
          <td><span style="background: #e5e7eb; padding: 0.2rem 0.5rem; border-radius: 1rem; font-size: 0.85rem;">{{
              r.category }}</span></td>
          <td style="font-family: monospace; font-size: 1rem; font-weight: 600;">
            {{ '%.2f'|format(r.amount or 0) }}
          </td>
          <td style="color: var(--color-text-muted);">{{ r.description }}</td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" style="text-align: center; padding: 2rem; color: var(--color-text-muted);">No data found for
            the selected filters.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<script>
  const s = document.getElementById('start_date');
  const e = document.getElementById('end_date');
  function syncBounds() {
    if (s.value) e.min = s.value;
    if (e.value) s.max = e.value;
  }
  s.addEventListener('change', syncBounds);
  e.addEventListener('change', syncBounds);
</script>
{% endblock %}